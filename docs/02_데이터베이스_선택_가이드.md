# ğŸ“˜ 02_ë°ì´í„°ë² ì´ìŠ¤_ì„ íƒ_ê°€ì´ë“œ

**í•™ìŠµ ëª©í‘œ**: í”„ë¡œì íŠ¸ì— ë§ëŠ” DB ì„ íƒ & Azure MySQL ë§ˆìŠ¤í„°

---

## ğŸ“Š DB ì ìœ ìœ¨ & ì‚¬ìš© í˜„í™© (2024)

### 1ìœ„: MySQL (30%)
- âœ… ê°€ì¥ ë§ì´ ì‚¬ìš©
- âœ… í’ë¶€í•œ ìë£Œ
- âœ… ë¬´ë£Œ ì˜¤í”ˆì†ŒìŠ¤

### 2ìœ„: PostgreSQL (25%)
- âœ… ê³ ê¸‰ ê¸°ëŠ¥
- âœ… JSON ì§€ì› ê°•ë ¥
- âœ… ëŒ€ê¸°ì—… ì„ í˜¸

### 3ìœ„: MongoDB (15%)
- âœ… NoSQL
- âœ… ìœ ì—°í•œ ìŠ¤í‚¤ë§ˆ
- âœ… JSON ë¬¸ì„œí˜•

### 4ìœ„: SQL Server (12%)
- âœ… Microsoft ìƒíƒœê³„
- âœ… ì—”í„°í”„ë¼ì´ì¦ˆê¸‰

---

## ğŸ” DB ì¢…ë¥˜ë³„ ë¹„êµ

### MySQL vs PostgreSQL vs MongoDB

```mermaid
graph TD
    A[DB ì„ íƒ] --> B{êµ¬ì¡°í™”ëœ ë°ì´í„°?}
    B -->|Yes| C{ê³ ê¸‰ ê¸°ëŠ¥ í•„ìš”?}
    B -->|No| D[MongoDB]
    
    C -->|Yes| E[PostgreSQL]
    C -->|No| F[MySQL]
```

| íŠ¹ì§• | MySQL | PostgreSQL | MongoDB |
|------|-------|------------|---------|
| íƒ€ì… | RDBMS | RDBMS | NoSQL |
| ì†ë„ | â­â­â­ | â­â­ | â­â­â­ |
| ê¸°ëŠ¥ | â­â­ | â­â­â­ | â­â­ |
| í•™ìŠµ ë‚œì´ë„ | ì‰¬ì›€ | ì¤‘ê°„ | ì‰¬ì›€ |
| JSON ì§€ì› | â­â­ | â­â­â­ | â­â­â­ |
| íŠ¸ëœì­ì…˜ | â­â­â­ | â­â­â­ | â­â­ |
| í™•ì¥ì„± | â­â­ | â­â­ | â­â­â­ |

---

## â˜ï¸ í´ë¼ìš°ë“œ DB ë¹„êµ

### Azure Database vs AWS RDS vs Google Cloud SQL

| íŠ¹ì§• | Azure MySQL | AWS RDS | Google Cloud SQL |
|------|-------------|---------|------------------|
| ê°€ê²© | $$ | $$ | $$$ |
| ì„±ëŠ¥ | â­â­â­ | â­â­â­ | â­â­â­ |
| ë°±ì—… | ìë™ | ìë™ | ìë™ |
| í™•ì¥ | ì‰¬ì›€ | ì‰¬ì›€ | ì¤‘ê°„ |
| í•œêµ­ ë¦¬ì „ | âœ… | âœ… | âŒ |
| í†µí•© | Azure ìƒíƒœê³„ | AWS ìƒíƒœê³„ | GCP ìƒíƒœê³„ |

---

## ğŸ¯ í˜„ì¬ ì‚¬ìš© ì¤‘: Azure Database for MySQL

### ì—°ê²° ì„¤ì •

```python
"""
Azure MySQL ì—°ê²°

ğŸ”— ê³µì‹ ë¬¸ì„œ: https://learn.microsoft.com/azure/mysql/
"""

from sqlalchemy import create_engine

# [ë°©ë²• 1] ê¸°ë³¸ ì—°ê²°
DATABASE_URL = (
    "mysql+pymysql://"
    "{username}:{password}@"
    "{servername}.mysql.database.azure.com:3306/"
    "{database}?ssl_ca=/path/to/DigiCertGlobalRootCA.crt.pem"
)

engine = create_engine(DATABASE_URL)

# [ë°©ë²• 2] SSL ì„¤ì • (Azure ê¶Œì¥)
DATABASE_URL = (
    "mysql+pymysql://"
    "leehyeoksu:%40dlwnstn55@"
    "fastsever.mysql.database.azure.com:3306/"
    "fastapi_db"
)

engine = create_engine(
    DATABASE_URL,
    connect_args={
        "ssl": {
            "ssl_ca": "/path/to/DigiCertGlobalRootCA.crt.pem"
        }
    }
)
```

### Azure Portalì—ì„œ ì„¤ì •

```bash
# 1. Azure Portal ì ‘ì†
# 2. "Azure Database for MySQL" ìƒì„±
# 3. ì„œë²„ ì´ë¦„: fastsever
# 4. ê´€ë¦¬ì: leehyeoksu
# 5. ë°©í™”ë²½ ê·œì¹™ ì¶”ê°€:
#    - ë‚´ IP ì£¼ì†Œ í—ˆìš©
#    - ë˜ëŠ” Azure ì„œë¹„ìŠ¤ í—ˆìš©

# 6. ë°ì´í„°ë² ì´ìŠ¤ ìƒì„±
CREATE DATABASE fastapi_db;
```

### ì„±ëŠ¥ ìµœì í™”

```python
"""
Azure MySQL ìµœì í™” íŒ
"""

# [1] Connection Pooling
engine = create_engine(
    DATABASE_URL,
    pool_size=10,          # ë™ì‹œ ì—°ê²° ìˆ˜
    max_overflow=20,       # ì¶”ê°€ ì—°ê²°
    pool_recycle=3600,     # 1ì‹œê°„ë§ˆë‹¤ ì¬ìƒì„±
    pool_pre_ping=True     # ì¿¼ë¦¬ ì „ ì—°ê²° í™•ì¸
)

# [2] ì¸ë±ìŠ¤ ìµœì í™”
"""
CREATE INDEX idx_user_email ON users(email);
CREATE INDEX idx_post_created ON posts(created_at);
"""

# [3] ì¿¼ë¦¬ ìµœì í™”
# âŒ N+1 ë¬¸ì œ
users = db.query(User).all()
for user in users:
    posts = db.query(Post).filter(Post.user_id == user.id).all()

# âœ… JOIN ì‚¬ìš©
from sqlalchemy.orm import joinedload
users = db.query(User).options(joinedload(User.posts)).all()
```

---

## ğŸ”¨ AWS RDS ê²½í—˜ í™œìš©

### AWS RDS vs Azure ì°¨ì´ì 

```python
"""
AWS RDS MySQL ì—°ê²° (ê²½í—˜ ìˆìŒ)
"""

# AWS RDS
DATABASE_URL = (
    "mysql+pymysql://"
    "admin:password@"
    "mydb.abc123.ap-northeast-2.rds.amazonaws.com:3306/"
    "mydb"
)

# Azure
DATABASE_URL = (
    "mysql+pymysql://"
    "admin:password@"
    "myserver.mysql.database.azure.com:3306/"
    "mydb"
)

# ì£¼ìš” ì°¨ì´ì :
# 1. ë„ë©”ì¸ í˜•ì‹ ë‹¤ë¦„
# 2. AWSëŠ” ë¦¬ì „ë³„ ì—”ë“œí¬ì¸íŠ¸
# 3. AzureëŠ” SSL ê¸°ë³¸ í™œì„±í™”
```

### ë§ˆì´ê·¸ë ˆì´ì…˜ (AWS â†’ Azure)

```bash
# 1. AWS RDSì—ì„œ ë¤í”„
mysqldump -h mydb.rds.amazonaws.com \
  -u admin -p mydb > backup.sql

# 2. Azureì— ë³µì›
mysql -h myserver.mysql.database.azure.com \
  -u admin -p mydb < backup.sql

# 3. ì—°ê²° ë¬¸ìì—´ ë³€ê²½
# ì½”ë“œì—ì„œ DATABASE_URLë§Œ ìˆ˜ì •
```

---

## ğŸ“¦ ì¶”ì²œ ë¼ì´ë¸ŒëŸ¬ë¦¬

### 1. SQLAlchemy-Utils
```python
"""
ORM í—¬í¼ ê¸°ëŠ¥

ì„¤ì¹˜: poetry add sqlalchemy-utils
"""

from sqlalchemy_utils import database_exists, create_database

# DB ìë™ ìƒì„±
if not database_exists(DATABASE_URL):
    create_database(DATABASE_URL)
```

### 2. Alembic - DB ë§ˆì´ê·¸ë ˆì´ì…˜
```bash
# ì„¤ì¹˜
poetry add alembic

# ì´ˆê¸°í™”
alembic init alembic

# ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒì„±
alembic revision --autogenerate -m "Add users table"

# ì ìš©
alembic upgrade head

# ë˜ëŒë¦¬ê¸°
alembic downgrade -1
```

### 3. asyncpg (PostgreSQL ë¹„ë™ê¸°)
```python
"""
PostgreSQLì„ ì“´ë‹¤ë©´ asyncpg ì¶”ì²œ

ì„¤ì¹˜: poetry add asyncpg
"""

from databases import Database

DATABASE_URL = "postgresql://user:pass@host/db"
database = Database(DATABASE_URL)

@app.on_event("startup")
async def startup():
    await database.connect()

@app.get("/users")
async def get_users():
    query = "SELECT * FROM users"
    return await database.fetch_all(query)
```

---

## ğŸ¯ ì‹¤ìŠµ ê³¼ì œ

### Day 1: Azure MySQL ìµœì í™”
```python
"""
ê³¼ì œ: í˜„ì¬ í”„ë¡œì íŠ¸ ìµœì í™”

1. Connection Pool ì„¤ì •
2. ì¸ë±ìŠ¤ ì¶”ê°€
3. ì¿¼ë¦¬ ì„±ëŠ¥ ì¸¡ì •
"""

import time
from sqlalchemy import create_engine

def measure_query_time(query_func):
    """ì¿¼ë¦¬ ì‹œê°„ ì¸¡ì •"""
    start = time.time()
    result = query_func()
    end = time.time()
    print(f"ì‹¤í–‰ ì‹œê°„: {end - start:.3f}ì´ˆ")
    return result

# ì¸ë±ìŠ¤ ì „ vs í›„ ë¹„êµ
query = db.query(User).filter(User.email == "test@example.com").first()
```

### Day 2: DB ë°±ì—… ìë™í™”
```python
"""
ê³¼ì œ: ìë™ ë°±ì—… ìŠ¤í¬ë¦½íŠ¸

ìš”êµ¬ì‚¬í•­:
1. ë§¤ì¼ ìƒˆë²½ 3ì‹œ ìë™ ë°±ì—…
2. Azure Blob Storageì— ì €ì¥
3. 7ì¼ ì´ìƒ íŒŒì¼ ìë™ ì‚­ì œ
"""

import subprocess
from datetime import datetime
import schedule

def backup_database():
    """DB ë°±ì—…"""
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    filename = f"backup_{timestamp}.sql"
    
    # mysqldump
    subprocess.run([
        "mysqldump",
        "-h", "fastsever.mysql.database.azure.com",
        "-u", "leehyeoksu",
        "-p", "password",
        "fastapi_db"
    ], stdout=open(filename, 'w'))
    
    print(f"âœ… ë°±ì—… ì™„ë£Œ: {filename}")

# ìŠ¤ì¼€ì¤„
schedule.every().day.at("03:00").do(backup_database)
```

---

## ğŸ’ª ë ˆë²¨ì—… ê³¼ì œ

### ğŸŒŸ ì´ˆê¸‰
- [ ] Azure MySQL ì—°ê²° ì„±ê³µ
- [ ] ê¸°ë³¸ CRUD ì‘ì„±
- [ ] ì¸ë±ìŠ¤ 1ê°œ ì¶”ê°€

### ğŸŒŸğŸŒŸ ì¤‘ê¸‰
- [ ] Connection Pool ìµœì í™”
- [ ] ì¿¼ë¦¬ ì„±ëŠ¥ ì¸¡ì •
- [ ] ìë™ ë°±ì—… ìŠ¤í¬ë¦½íŠ¸

### ğŸŒŸğŸŒŸğŸŒŸ ê³ ê¸‰
- [ ] Alembic ë§ˆì´ê·¸ë ˆì´ì…˜ ë„ì…
- [ ] Read Replica ì„¤ì •
- [ ] ëª¨ë‹ˆí„°ë§ (Azure Monitor)

---

**ë‹¤ìŒ í•™ìŠµ**: [03_FastAPI_ê¸°ì´ˆ.md](./03_FastAPI_ê¸°ì´ˆ.md) ğŸš€
